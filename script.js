// ==================== CONFIGURATION ====================
// Replace these values with your own content.

/**
 * HEBREW LETTER TEXT
 * Replace this with your own Hebrew message.
 * Use \n for new lines.
 */
const letterText = `טוב אז היום לנסיכה שפה יש יום הולדת... ומה אני כבר יכול לאחל לילדה כל כך מדהימה?

בראש ובראשונה אני מאחל לך בריאות, שתמיד תרגישי חזקה ובריאה. אני מאחל לך הצלחה בכל מעשה ידייך, אושר, יושר, עושר, הצלחה בלימודים, שתמיד יהיה לך שפע מהכל ושתמיד תיהי מוקפת בחברים טובים שאוהבים אותך. אני מאחל לך שתמיד תדעי להבדיל בין טוב לרע, ושתמיד תלמדי מטעויות, תשכילי, ותגדלי מהן - כי בסוף יש מתנות שמקבלים רק מטעויות 
ואמממ... איך אפשר לסיים את הפסקה הזאת בלי לאחל לי ולך משהו לשנה הזאת? אני מאחל לי ולך עוד תקופה ארוכה של חוויות, תקופה ארוכה של הצלחות, כיף וצחוקים שרק אנחנו יודעים לעשות❤️

את יודעת אנחנו מכירים רק כמעט חודשיים וזה מרגיש כמו כמה שנים... אני איתך יותר ממה שאני עם המשפחה שלי, וכיף לי, הצחוקים שלנו מצחיקים אותי ומעלים לי חיוך על הפנים בכל פעם מחדש, החיוך היפה שלך גורם לי ולעולם לחייך ביחד איתו ואני מקווה שהוא לעולם לא יפסק.
ללמוד איתך גורם לי להרגיש שאני לא לבד, מי חשב שכשאגיע לאוניברסיטה אהיה במקום הזה?
אומנם אני עוזר לך המון, יושב איתך על קורסים שאני בכלל לא לוקח ומשקיע זמן שאין לי, אבל אני לא יודע למה, את פשוט מיוחדת, ואת שווה את זה, את שווה את כל הדבר הזה שהכנתי עכשיו, את כל הזמן שישבתי על זה. לפני שהכרתי אותך לא הייתי במקום הזה שהיה לי מישהו שיכולתי ללמוד ולהיות איתו בצורה הזאת, ואם לומר את האמת אני לא זוכר שאי פעם היה לי, מאז שנכנסת לי לחיים ומאז שהתחלנו לשבת ביחד באמת יותר כיף לי ואני באמת יותר שמח, ואני חושב שעל זה אני צריך להגיד לך תודה. אולי זה נראה כאילו אני עם שריון כזה ואני אף פעם לא מרגיש ככה, אבל באמת, לפני שנכנסתי לאוניברסיטה אני הייתי די לבד, הייתי עם הבנות במשרד והיו לי קצת חברים מן הסתם מהתיכון, אבל בגלל הצבא אז הייתי יכול להיפגש איתם רק כל כמה חודשים, אז הייתי די לבד, עד שהכרתי אותך - ואני באמת לא זוכר מתי היה לי כיף, מתי היה לי כימיה כזאת, ומתי שימח אותי לשבת עם מישהו בצורה הזאת - אז אור, תודה לך על כל זה❤️

בהזדמנות הזאת אני גם רוצה להגיד לך שהדבר הזה שהכנתי הוא לא רק לעכשיו, הוא לא רק לנקודת הזמן הזאת, הכנתי את זה בשביל שתוכלי לראות את ההתקדמות שלך - כי אני יודע כמה פידבק חשוב לך, אז אולי פידבק עצמי, אולי לראות את ההתקדמות הזאת בתמונות או בטיימליין יגרום לפידבק הזה לבוא, יגרום לך ולחיוך היפה שלך לעלות בכל פעם שאת קצת מתוסכלת או עצובה. הפרוייקט הזה הוא פרוייקט שלך, פרוייקט שאת תוכלי להוסיף בו תמונות, לשנות את הטיימליין, להוסיף רגעים מצחיקים ורגעים שמחים שלך לאורך התואר - רגעים שישמרו לנצח, שילכו איתך כל החיים. רגעים שתשמרי ותוכלי להיזכר בהם בכל רגע קטן בחיים שלך, בכל נקודת עצב או משבר, ואפילו כשאת סתם שמחה ובא לך להסתכל על כל התהליך הזה שלך❤️

יום הולדת שמח נסיכה שלי❤️

`;

/**
 * PHOTOS ARRAY
 * Replace placeholder URLs with your actual photo URLs.
 * Add or remove items as needed.
 */
const photos = [
    { url: "Images/Memories/Chupi_And_We.png", caption: "Good times With Chupi" },
    { url: "Images/Memories/Study_Memories.jfif", caption: "Study sessions" },
    { url: "Images/Memories/Spain_Memories.jfif", caption: "Good Times in Spain" },
    { url: "Images/Memories/Sitting_on_chair_instead_infi.jpeg", caption: "Enjoying a chair instead of infi" },
    { url: "Images/Memories/Or_Big_Mucles.jfif", caption: "Or's Big Mucles" },
    { url: "Images/Memories/Birthday_Girl.png", caption: "Birthday Girl" }

    // ADD MORE PHOTOS: Copy the object structure above and paste below
];

/**
 * SONGS ARRAY
 * Replace with actual song data.
 * audioSrc should be a URL to an MP3 file or audio stream.
 */
const songs = [
    {
        songName: "Tonight and Always",
        artist: "Selena Gomez & ZAYN",
        audioSrc: encodeURI("Songs/Selena Gomez & ZAYN - Tonight and Always.mp3"),
        coverImage: "Images/Singer_Images/Zayn.jpg"
    },
    {
        songName: "Aktimel & LED Lights (Happy Birthday Or)",
        artist: "Friends",
        audioSrc: encodeURI("Songs/Aktimel & LED Lights (Happy Birthday Or).mp3"),
        coverImage: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=200"
    },
    {
        songName: "Or's Song",
        artist: "Friends",
        audioSrc: encodeURI("Songs/Or's song.mp3"),
        coverImage: "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=200"
    },
    {
        songName: "Study Vibes",
        artist: "Chill Beats",
        audioSrc: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",
        coverImage: "https://images.unsplash.com/photo-1459749411175-04bf5292ceea?w=200"
    },
    {
        songName: "Memories",
        artist: "University Days",
        audioSrc: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3",
        coverImage: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=200"
    }
    // ADD MORE SONGS: Copy the object structure above and paste below
];

/**
 * UNIVERSITY COURSES
 * Completion state is saved in localStorage.
 */
const courses = [
    { id: "calc1", name: "Calculus 1" },
    { id: "calc2", name: "Calculus 2" },
    { id: "linalg1", name: "Linear Algebra 1" },
    { id: "linalg2", name: "Linear Algebra 2" },
    { id: "discrete", name: "Discrete Math" },
    { id: "introcs", name: "Introduction to CS" }
    // ADD MORE COURSES: Copy the object structure above and paste below
];

/**
 * THINGS SHE LIKES
 * Replace with actual images and captions of things she enjoys.
 */
const thingsYouLike = [
    { image: "Images/Liked_Things/My_Demon.jpg", caption: "Korean Series" },
    { image: "Images/Liked_Things/The_Paper_Palace.jpg", caption: "Books and stories" },
    { image: "Images/Liked_Things/Rambela_Spain.webp", caption: "Travel dreams" },
    { image: "Images/Liked_Things/Chrismas_Jacket.avif", caption: "Photography magic" },
    { image: "Images/Liked_Things/Beach.jfif", caption: "Beach sunsets" },
    { image: "Images/Liked_Things/Love_Yves.jpeg", caption: "YVES GODIN" }

    // ADD MORE ITEMS: Copy the object structure above and paste below
];

/**
 * FUNNY MOMENTS
 * Add either images or YouTube videos. For YouTube, supply the videoId.
 * type: "image" | "video"
 * src: path to image or videoId for YouTube
 */
const funnyMoments = [
    { type: "video", videoId: "ncxivHVBrC4", title: "Symbols in Math From Godin" },
    { type: "video", videoId: "BajsD4AcR-A", title: "Godin Core 1" },
    { type: "video", videoId: "muUv__RJZaY", title: "Little Story About our Godin..." },
    { type: "video", videoId: "C5c2NRpawow", title: "Godin Core 2" },
    { type: "video", videoId: "eaN2otp--B8", title: "Our lovely Alex and his strange words..." }
    // ADD MORE MOMENTS: For YouTube videos, add { type: "video", videoId: "YOUTUBE_ID", title: "Your title" }
    // For images, add { type: "image", src: "images/your-photo.jpg", title: "Caption" }
];

// Brighter twinkle colors for the tree lights
const treeColors = ['#ff4f9a', '#ffb300', '#2ecc71', '#1e90ff', '#ff6fd8', '#ffd166'];
// Balloon images for intro float (add your filenames inside images/balloons)
const balloonImages = [
    "images/balloons/balloon1.svg",
    "images/balloons/balloon2.svg",
    "images/balloons/baloon3.svg"
];

// ==================== DOM ELEMENTS ====================

const envelopePage = document.getElementById('envelope-page');
const memoriesPage = document.getElementById('memories-page');
const envelopeWrapper = document.getElementById('envelope-wrapper');
const letter = document.getElementById('letter');
const letterTextElement = document.getElementById('letter-text');
const instruction = document.getElementById('instruction');
const continueBtn = document.getElementById('continue-btn');
const backBtn = document.getElementById('back-btn');
const decorations = document.getElementById('decorations');

// Memories sections
const photosGrid = document.getElementById('photos-grid');
const songsContainer = document.getElementById('songs-container');
const timeline = document.getElementById('timeline');
const likesGrid = document.getElementById('likes-grid');
const funnyGrid = document.getElementById('funny-grid');
let sectionObserver;

// ==================== STATE VARIABLES ====================

let isEnvelopeOpened = false;
let isTyping = false;
let currentAudio = null;
let currentPlayBtn = null;
let globeModal;
let globeModalContent;
let imageModal;
let imageModalImg;
let backgroundAudio;
let hasStartedBackground = false;
let autoScrollLetter = true;

// ==================== INITIALIZATION ====================

document.addEventListener('DOMContentLoaded', () => {
    createDecorations();
    setupEnvelopeInteraction();
    setupContinueButton();
    setupBackButton();
    populatePhotos();
    populateSongs();
    populateTimeline();
    populateLikes();
    populateFunnyMoments();
    buildChristmasTreeClean();
    setupGlobeModal();
    setupSectionObserver();
    setupImageModal();
    setupLetterScrollControl();
});

// ==================== DECORATIONS (BALLOONS & CONFETTI) ====================

/**
 * Creates floating balloons and falling confetti for visual effect.
 */
function createDecorations() {
    const balloonEmojis = ['\u{1F388}', '\u{1F48C}', '\u2728', '\u{1F380}', '\u{1F338}', '\u{1F496}'];
    const useImages = balloonImages.length > 0;

    // Continuous emoji balloons in the background
    for (let i = 0; i < 8; i++) {
        const balloon = document.createElement('div');
        balloon.className = 'balloon';
        balloon.textContent = balloonEmojis[Math.floor(Math.random() * balloonEmojis.length)];
        balloon.style.fontSize = '2.6rem';
        balloon.style.left = Math.random() * 100 + '%';
        balloon.style.animationDelay = Math.random() * 10 + 's';
        balloon.style.animationDuration = (14 + Math.random() * 10) + 's';
        decorations.appendChild(balloon);
    }

    // One-time image balloons burst
    const introBalloons = [];
    const burstCount = useImages ? Math.min(12, Math.max(balloonImages.length, 4)) : 0;
    for (let i = 0; i < burstCount; i++) {
        const balloon = document.createElement('div');
        balloon.className = 'balloon img-balloon';
        const imgSrc = balloonImages[i % balloonImages.length];
        balloon.style.backgroundImage = `url(${imgSrc})`;
        balloon.style.left = Math.random() * 100 + '%';
        balloon.style.animationDelay = Math.random() * 2 + 's';
        decorations.appendChild(balloon);
        introBalloons.push(balloon);
    }
    if (introBalloons.length) {
        setTimeout(() => {
            introBalloons.forEach((b) => b.remove());
        }, 10000);
    }

    const confettiColors = ['#ff7fb7', '#ffd700', '#ffc8dc', '#8ddba3', '#ff9fc7', '#ffd9ea'];
    for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
        confetti.style.animationDelay = Math.random() * 8 + 's';
        confetti.style.animationDuration = (6 + Math.random() * 4) + 's';
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        confetti.style.width = (5 + Math.random() * 10) + 'px';
        confetti.style.height = (5 + Math.random() * 10) + 'px';
        decorations.appendChild(confetti);
    }
}

// ==================== ENVELOPE INTERACTION ====================

/**
 * Sets up click handler for the envelope.
 * On click: opens envelope, slides out letter, starts typewriter effect.
 */
function setupEnvelopeInteraction() {
    envelopeWrapper.addEventListener('click', () => {
        if (!isEnvelopeOpened) {
            openEnvelope();
        }
        maybeStartBackground();
    });
}

/**
 * Opens the envelope and triggers the typewriter animation.
 */
function openEnvelope() {
    isEnvelopeOpened = true;
    envelopeWrapper.classList.add('opened');
    instruction.classList.add('hidden');
    instruction.setAttribute('aria-hidden', 'true');
    
    setTimeout(() => {
        startTypewriter();
    }, 800);
    // allow skipping after 5 seconds even if typing not finished
    setTimeout(() => {
        continueBtn.classList.add('visible');
    }, 5000);
}

/**
 * Typewriter effect for the Hebrew letter.
 */
function startTypewriter() {
    if (isTyping) return;
    isTyping = true;
    
    let index = 0;
    letterTextElement.textContent = '';
    
    const typeInterval = setInterval(() => {
        if (index < letterText.length) {
            letterTextElement.textContent += letterText[index];
            index++;
            if (autoScrollLetter) {
                letter.scrollTop = letter.scrollHeight;
            }
        } else {
            clearInterval(typeInterval);
            letterTextElement.classList.add('typing-done');
            setTimeout(() => {
                continueBtn.classList.add('visible');
            }, 500);
        }
    }, 50);
}

// ==================== PAGE NAVIGATION ====================

function setupContinueButton() {
    continueBtn.addEventListener('click', () => {
        switchToMemoriesPage();
    });
}

function setupBackButton() {
    backBtn.addEventListener('click', () => {
        switchToEnvelopePage();
    });
}

function switchToMemoriesPage() {
    envelopePage.classList.remove('active');
    memoriesPage.classList.add('active');
    setupSectionObserver();
    window.scrollTo(0, 0);
}

function switchToEnvelopePage() {
    resetEnvelope();
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        if (currentPlayBtn) {
            currentPlayBtn.classList.remove('playing');
            currentPlayBtn.closest('.song-card').classList.remove('active');
        }
    }
    
    memoriesPage.classList.remove('active');
    envelopePage.classList.add('active');
    window.scrollTo(0, 0);
}

// Intersection observer for revealing sections when they enter view
function setupSectionObserver() {
    const sections = document.querySelectorAll('.section');
    if (!sections.length) return;
    if (sectionObserver) sectionObserver.disconnect();

    let idx = 0;
    sectionObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                const delay = Number(entry.target.dataset.stagger) || 0;
                setTimeout(() => entry.target.classList.add('visible'), delay);
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.25 });

    sections.forEach((section) => {
        if (!section.classList.contains('visible')) {
            section.dataset.stagger = idx * 120;
            sectionObserver.observe(section);
            idx += 1;
        }
    });
}

// ==================== PHOTOS SECTION ====================

function populatePhotos() {
    photosGrid.innerHTML = '';
    photos.forEach((photo, index) => {
        const photoCard = document.createElement('div');
        photoCard.className = 'photo-card';
        photoCard.innerHTML = `
            <img src="${photo.url}" alt="Memory ${index + 1}" class="zoomable" loading="lazy">
            <div class="photo-caption">${photo.caption}</div>
        `;
        photosGrid.appendChild(photoCard);
        const imgEl = photoCard.querySelector('img');
        imgEl.addEventListener('click', () => openImageModal(photo.url, photo.caption || `Memory ${index + 1}`));
    });
}

// ==================== SONGS SECTION ====================

function populateSongs() {
    songsContainer.innerHTML = '';
    
    songs.forEach((song, index) => {
        const songCard = document.createElement('div');
        songCard.className = 'song-card';
        songCard.innerHTML = `
            <img src="${song.coverImage}" alt="${song.songName}" class="song-cover">
            <div class="song-info">
                <div class="song-name">${song.songName}</div>
                <div class="song-artist">${song.artist}</div>
                <div class="song-progress">
                    <div class="song-progress-bar" id="progress-${index}"></div>
                </div>
                <div class="song-time"><span class="current-time">0:00</span> / <span class="duration">0:00</span></div>
            </div>
            <button class="play-btn" id="play-btn-${index}"></button>
            <audio id="audio-${index}" src="${song.audioSrc}" preload="none"></audio>
        `;
        songsContainer.appendChild(songCard);
        
        const audio = document.getElementById(`audio-${index}`);
        const playBtn = document.getElementById(`play-btn-${index}`);
        const progressBar = document.getElementById(`progress-${index}`);
        const progressWrap = songCard.querySelector('.song-progress');
        const currentTimeEl = songCard.querySelector('.current-time');
        const durationEl = songCard.querySelector('.duration');
        
        playBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            togglePlayPause(audio, playBtn, songCard, progressBar);
        });
        
        audio.addEventListener('timeupdate', () => {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = progress + '%';
            currentTimeEl.textContent = formatTime(audio.currentTime);
        });
        audio.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(audio.duration);
        });
        // If metadata was already loaded (cache), set duration
        if (!Number.isNaN(audio.duration) && audio.duration > 0) {
            durationEl.textContent = formatTime(audio.duration);
        }

        const seekTo = (clientX) => {
            const rect = progressWrap.getBoundingClientRect();
            const pct = Math.min(Math.max((clientX - rect.left) / rect.width, 0), 1);
            if (!Number.isNaN(audio.duration) && audio.duration > 0) {
                audio.currentTime = pct * audio.duration;
                progressBar.style.width = `${pct * 100}%`;
            }
        };

        progressWrap.addEventListener('click', (e) => {
            e.stopPropagation();
            seekTo(e.clientX);
        });
        progressWrap.addEventListener('touchstart', (e) => {
            if (!e.touches || !e.touches.length) return;
            seekTo(e.touches[0].clientX);
        });
        
        audio.addEventListener('ended', () => {
            playBtn.classList.remove('playing');
            songCard.classList.remove('active');
            progressBar.style.width = '0%';
            currentAudio = null;
            currentPlayBtn = null;
            currentTimeEl.textContent = '0:00';
        });
    });
}

function stopOtherAudio(activeAudio) {
    if (backgroundAudio && !backgroundAudio.paused) {
        backgroundAudio.pause();
        backgroundAudio.currentTime = 0;
    }

    if (!songsContainer) return;
    const songAudios = songsContainer.querySelectorAll('audio');
    songAudios.forEach((audioEl) => {
        if (audioEl === activeAudio) return;
        audioEl.pause();
        audioEl.currentTime = 0;
        const card = audioEl.closest('.song-card');
        if (card) {
            card.classList.remove('active');
        }
        const btn = card ? card.querySelector('.play-btn') : null;
        if (btn) {
            btn.classList.remove('playing');
        }
        const bar = card ? card.querySelector('.song-progress-bar') : null;
        if (bar) {
            bar.style.width = '0%';
        }
        const currentTimeEl = card ? card.querySelector('.current-time') : null;
        if (currentTimeEl) {
            currentTimeEl.textContent = '0:00';
        }
    });

    if (currentAudio && currentAudio !== activeAudio) {
        currentAudio = null;
        currentPlayBtn = null;
    }
}

function togglePlayPause(audio, playBtn, songCard, progressBar) {
    if (currentAudio === audio && !audio.paused) {
        audio.pause();
        playBtn.classList.remove('playing');
        songCard.classList.remove('active');
        return;
    }

    stopOtherAudio(audio);

    audio.play();
    playBtn.classList.add('playing');
    songCard.classList.add('active');
    currentAudio = audio;
    currentPlayBtn = playBtn;
}

// ==================== TIMELINE SECTION ====================

function populateTimeline() {
    timeline.innerHTML = '';
    const completedCourses = JSON.parse(localStorage.getItem('completedCourses')) || {};
    
    courses.forEach((course) => {
        const isCompleted = completedCourses[course.id] || false;
        
        const timelineItem = document.createElement('div');
        timelineItem.className = `timeline-item ${isCompleted ? 'completed' : ''}`;
        timelineItem.dataset.courseId = course.id;
        timelineItem.innerHTML = `
            <div class="timeline-content">
                <span class="course-name">${course.name}</span>
                <div class="course-checkbox">
                    <span>${isCompleted ? 'Completed' : 'Mark as done'}</span>
                    <div class="checkbox-custom"></div>
                </div>
            </div>
        `;
        
        timelineItem.addEventListener('click', () => {
            toggleCourseCompletion(timelineItem, course.id);
        });
        
        timeline.appendChild(timelineItem);
    });
}

function toggleCourseCompletion(item, courseId) {
    const isCompleted = item.classList.toggle('completed');
    const checkboxText = item.querySelector('.course-checkbox span');
    checkboxText.textContent = isCompleted ? 'Completed' : 'Mark as done';
    
    const completedCourses = JSON.parse(localStorage.getItem('completedCourses')) || {};
    completedCourses[courseId] = isCompleted;
    localStorage.setItem('completedCourses', JSON.stringify(completedCourses));
}

// ==================== THINGS YOU LIKE SECTION ====================

function populateLikes() {
    likesGrid.innerHTML = '';
    addSnowGlobeCard();
    
    thingsYouLike.forEach((item) => {
        const likeCard = document.createElement('div');
        likeCard.className = 'like-card';
        likeCard.innerHTML = `
            <img src="${item.image}" alt="${item.caption}" class="like-image zoomable" loading="lazy">
            <div class="like-caption">${item.caption}</div>
        `;
        likesGrid.appendChild(likeCard);
        const imgEl = likeCard.querySelector('img');
        imgEl.addEventListener('click', () => openImageModal(item.image, item.caption));
    });
}

// ==================== FUNNY MOMENTS ====================

function populateFunnyMoments() {
    if (!funnyGrid) return;
    funnyGrid.innerHTML = '';
    funnyMoments.forEach((moment) => {
        const card = document.createElement('div');
        card.className = 'moment-card';

        const media = document.createElement('div');
        media.className = 'moment-media';

        if (moment.type === 'video' && moment.videoId) {
            const placeholder = document.createElement('div');
            placeholder.className = 'video-placeholder';
            placeholder.style.backgroundImage = `url(https://img.youtube.com/vi/${moment.videoId}/hqdefault.jpg)`;
            placeholder.setAttribute('data-video-id', moment.videoId);
            placeholder.setAttribute('data-title', moment.title || 'Video');
            const playBadge = document.createElement('div');
            playBadge.className = 'video-play';
            playBadge.innerHTML = '&#9658;';
            placeholder.appendChild(playBadge);
            placeholder.addEventListener('click', () => {
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube.com/embed/${moment.videoId}?autoplay=1&modestbranding=1&rel=0&playsinline=1&iv_load_policy=3`;
                iframe.title = moment.title || 'Video';
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.allowFullscreen = true;
                const wrapper = document.createElement('div');
                wrapper.className = 'video-wrapper';
                wrapper.appendChild(iframe);
                media.innerHTML = '';
                media.appendChild(wrapper);
            });
            media.appendChild(placeholder);
        } else if (moment.type === 'image' && moment.src) {
            const img = document.createElement('img');
            img.src = moment.src;
            img.alt = moment.title || 'Funny moment';
            img.addEventListener('click', () => openImageModal(moment.src, moment.title || 'Funny moment'));
            media.appendChild(img);
        }

        const title = document.createElement('div');
        title.className = 'moment-title';
        title.textContent = moment.title || '';

        card.append(media, title);
        funnyGrid.appendChild(card);
    });
}

function addSnowGlobeCard() {
    const card = document.createElement('div');
    card.className = 'like-card snow-globe-card';
    const globeWrapper = document.createElement('div');
    globeWrapper.className = 'globe-wrapper';
    const { globe } = createGlobeElement(''); // default size
    globeWrapper.appendChild(globe);
    const base = document.createElement('div');
    base.className = 'globe-base';
    const caption = document.createElement('div');
    caption.className = 'like-caption';
    caption.textContent = 'Snow globe';
    globeWrapper.appendChild(base);
    globeWrapper.appendChild(caption);
    card.appendChild(globeWrapper);
    likesGrid.appendChild(card);
    bindGlobeInteractions(globe, true);
}

// ==================== SNOW GLOBE HELPERS ====================

function createGlobeElement(sizeClass = '') {
    const globe = document.createElement('div');
    globe.className = `globe ${sizeClass}`.trim();
    globe.setAttribute('aria-label', 'Snow globe');

    const inner = document.createElement('div');
    inner.className = 'globe-inner';

    const scene = document.createElement('div');
    scene.className = 'globe-scene';
    const ground = document.createElement('div');
    ground.className = 'ground';
    const snowHeap = document.createElement('div');
    snowHeap.className = 'snow-heap';
    const leftTree = document.createElement('div');
    leftTree.className = 'tree-shape';
    leftTree.style.marginRight = '12px';
    const leftSnow = document.createElement('div');
    leftSnow.className = 'tree-snow';
    leftTree.appendChild(leftSnow);
    const rightTree = document.createElement('div');
    rightTree.className = 'tree-shape';
    rightTree.style.marginLeft = '12px';
    const rightSnow = document.createElement('div');
    rightSnow.className = 'tree-snow';
    rightTree.appendChild(rightSnow);
    const house = document.createElement('div');
    house.className = 'house';
    const roof = document.createElement('div');
    roof.className = 'roof';
    const door = document.createElement('div');
    door.className = 'door';
    const windowEl = document.createElement('div');
    windowEl.className = 'window';
    house.append(roof, door, windowEl);
    scene.append(ground, leftTree, house, rightTree, snowHeap);

    const snowContainer = document.createElement('div');
    snowContainer.className = 'snow-container';

    globe.append(inner, scene, snowContainer);

    // Create snowflakes
    const flakeCount = sizeClass === 'large' ? 42 : 28;
    for (let i = 0; i < flakeCount; i++) {
        const flake = document.createElement('span');
        flake.className = 'snowflake';
        flake.style.left = `${Math.random() * 100}%`;
        flake.style.animationDelay = `${Math.random() * 3}s`;
        flake.style.animationDuration = `${2 + Math.random() * 3}s`;
        flake.style.opacity = `${0.7 + Math.random() * 0.3}`;
        flake.style.width = flake.style.height = `${2 + Math.random() * 3}px`;
        snowContainer.appendChild(flake);
    }

    return { globe };
}

function bindGlobeInteractions(globe, openModalOnClick = true) {
    const triggerBurst = () => {
        globe.classList.add('active');
        setTimeout(() => globe.classList.remove('active'), 1400);
    };

    globe.addEventListener('mouseenter', triggerBurst);
    globe.addEventListener('click', (e) => {
        e.stopPropagation();
        if (openModalOnClick) {
            openGlobeModal();
        } else {
            triggerBurst();
        }
    });
}

function setupGlobeModal() {
    globeModal = document.createElement('div');
    globeModal.className = 'globe-modal';
    globeModal.innerHTML = `
        <div class="globe-modal-content">
            <button class="globe-modal-close" aria-label="Close globe">×</button>
            <div class="globe-large-wrapper"></div>
        </div>
    `;
    globeModalContent = globeModal.querySelector('.globe-large-wrapper');
    document.body.appendChild(globeModal);

    globeModal.addEventListener('click', (e) => {
        if (e.target === globeModal || e.target.classList.contains('globe-modal-close')) {
            globeModal.classList.remove('active');
            globeModalContent.innerHTML = '';
        }
    });
}

function openGlobeModal() {
    if (!globeModalContent) return;
    globeModalContent.innerHTML = '';
    const { globe } = createGlobeElement('large');
    const base = document.createElement('div');
    base.className = 'globe-base';
    globeModalContent.appendChild(globe);
    globeModalContent.appendChild(base);
    bindGlobeInteractions(globe, false);
    globeModal.classList.add('active');
    globe.classList.add('active'); // instant snow burst on open
    setTimeout(() => globe.classList.remove('active'), 1400);
}

// ==================== IMAGE MODAL ====================

function setupImageModal() {
    imageModal = document.getElementById('image-modal');
    imageModalImg = document.getElementById('image-modal-img');
    const closeBtn = document.querySelector('.image-modal-close');
    if (!imageModal || !imageModalImg || !closeBtn) return;

    const close = () => {
        imageModal.classList.remove('active');
        imageModal.setAttribute('aria-hidden', 'true');
        imageModalImg.src = '';
        imageModalImg.alt = '';
    };

    closeBtn.addEventListener('click', close);
    imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) close();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
    });
}

function openImageModal(src, altText) {
    if (!imageModal || !imageModalImg) return;
    imageModalImg.src = src;
    imageModalImg.alt = altText || 'Expanded image';
    imageModal.classList.add('active');
    imageModal.setAttribute('aria-hidden', 'false');
}

// Background music (starts on first envelope click to satisfy autoplay policies)
function maybeStartBackground() {
    if (hasStartedBackground) return;
    backgroundAudio = new Audio(encodeURI("Songs/Selena Gomez & ZAYN - Tonight and Always.mp3"));
    backgroundAudio.loop = false;
    backgroundAudio.volume = 0.35;
    const playPromise = backgroundAudio.play();
    if (playPromise && playPromise.catch) {
        playPromise.catch(() => {
            // ignore autoplay block; will attempt again on next interaction
            hasStartedBackground = false;
        });
    }
    hasStartedBackground = true;
}

// Format seconds to M:SS
function formatTime(seconds) {
    const safeSeconds = Number.isFinite(seconds) ? Math.max(seconds, 0) : 0;
    const mins = Math.floor(safeSeconds / 60);
    const secs = Math.floor(safeSeconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// ==================== HOLIDAY TREE ====================

function buildChristmasTree() {
    const treeEl = document.getElementById('christmas-tree');
    if (!treeEl) return;
    const pattern = [
        "        ★        ",
        "        *        ",
        "       ***       ",
        "      *****      ",
        "     *******     ",
        "    *********    ",
        "   ***********   ",
        "  *************  ",
        " *************** ",
        "*****************",
        "       |||       ",
        "       |||       "
    ];

    treeEl.innerHTML = '';
    pattern.forEach(line => {
        const lineEl = document.createElement('div');
        [...line].forEach(char => {
            if (char === '*') {
                const light = document.createElement('span');
                light.className = 'tree-light';
                light.textContent = '*';
                lineEl.appendChild(light);
            } else {
                lineEl.appendChild(document.createTextNode(char));
            }
        });
        treeEl.appendChild(lineEl);
    });

    const lights = treeEl.querySelectorAll('.tree-light');
    setInterval(() => {
        lights.forEach(light => {
            const random = treeColors[Math.floor(Math.random() * treeColors.length)];
            light.style.color = random;
        });
    }, 650);
}

// Clean render for the tree (used by init)
function buildChristmasTreeClean() {
    const treeEl = document.getElementById('christmas-tree');
    if (!treeEl) return;
    const pattern = [
        "        ★        ",
        "        *        ",
        "       ***       ",
        "      *****      ",
        "     *******     ",
        "    *********    ",
        "   ***********   ",
        "  *************  ",
        " *************** ",
        "*****************",
        "       |||       ",
        "       |||       "
    ];

    treeEl.innerHTML = '';
    pattern.forEach(line => {
        const lineEl = document.createElement('div');
        [...line].forEach(char => {
            if (char === '*') {
                const light = document.createElement('span');
                light.className = 'tree-light';
                light.textContent = '*';
                lineEl.appendChild(light);
            } else {
                lineEl.appendChild(document.createTextNode(char));
            }
        });
        treeEl.appendChild(lineEl);
    });

    const lights = treeEl.querySelectorAll('.tree-light');
    setInterval(() => {
        lights.forEach(light => {
            const random = treeColors[Math.floor(Math.random() * treeColors.length)];
            light.style.color = random;
        });
    }, 650);
}

// ==================== UTILITY FUNCTIONS ====================

function resetEnvelope() {
    isEnvelopeOpened = false;
    isTyping = false;
    envelopeWrapper.classList.remove('opened');
    letterTextElement.textContent = '';
    letterTextElement.classList.remove('typing-done');
    continueBtn.classList.remove('visible');
    instruction.classList.remove('hidden');
    instruction.removeAttribute('aria-hidden');
    autoScrollLetter = true;
}

// Expose reset function globally for testing
window.resetEnvelope = resetEnvelope;

// Disable auto-scroll when user manually interacts with the letter
function setupLetterScrollControl() {
    const stopAuto = () => { autoScrollLetter = false; };
    ['wheel', 'touchstart', 'mousedown', 'keydown'].forEach(evt => {
        letter.addEventListener(evt, stopAuto, { passive: true });
    });
}
